import{sharedConfig as je}from"solid-js";import{provideRequestEvent as Te}from"solid-js/web/storage";import{H3Event as _,setHeader as Ce,getRequestURL as $e,getRequestIP as _e,setResponseStatus as De,getResponseStatus as Ue,getResponseStatusText as Me,getResponseHeaders as qe,getResponseHeader as He,setResponseHeader as Le,appendResponseHeader as Be,getRequestWebStream as We,removeResponseHeader as Ne,eventHandler as Ke}from"h3";import{AsyncLocalStorage as Ze}from"node:async_hooks";var Ge=(t=>(t[t.AggregateError=1]="AggregateError",t[t.ArrowFunction=2]="ArrowFunction",t[t.ErrorPrototypeStack=4]="ErrorPrototypeStack",t[t.ObjectAssign=8]="ObjectAssign",t[t.BigIntTypedArray=16]="BigIntTypedArray",t))(Ge||{});function f(t,e){if(!t)throw e}function Je(t){switch(t){case'"':return'\\"';case"\\":return"\\\\";case`
`:return"\\n";case"\r":return"\\r";case"\b":return"\\b";case"	":return"\\t";case"\f":return"\\f";case"<":return"\\x3C";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return}}function h(t){let e="",r=0,s;for(let i=0,a=t.length;i<a;i++)s=Je(t[i]),s&&(e+=t.slice(r,i)+s,r=i+1);return r===0?e=t:e+=t.slice(r),e}function Qe(t){switch(t){case"\\\\":return"\\";case'\\"':return'"';case"\\n":return`
`;case"\\r":return"\r";case"\\b":return"\b";case"\\t":return"	";case"\\f":return"\f";case"\\x3C":return"<";case"\\u2028":return"\u2028";case"\\u2029":return"\u2029";default:return t}}function v(t){return t.replace(/(\\\\|\\"|\\n|\\r|\\b|\\t|\\f|\\u2028|\\u2029|\\x3C)/g,Qe)}var b="__SEROVAL_REFS__",A="$R",x=`self.${A}`;function Ye(t){return t==null?`${x}=${x}||[]`:`(${x}=${x}||{})["${h(t)}"]=[]`}var ue=new Map,y=new Map;function D(t){return ue.has(t)}function Xe(t){return y.has(t)}function et(t){return f(D(t),new Mt(t)),ue.get(t)}function tt(t){return f(Xe(t),new qt(t)),y.get(t)}typeof globalThis<"u"?Object.defineProperty(globalThis,b,{value:y,configurable:!0,writable:!1,enumerable:!1}):typeof window<"u"?Object.defineProperty(window,b,{value:y,configurable:!0,writable:!1,enumerable:!1}):typeof self<"u"?Object.defineProperty(self,b,{value:y,configurable:!0,writable:!1,enumerable:!1}):typeof global<"u"&&Object.defineProperty(global,b,{value:y,configurable:!0,writable:!1,enumerable:!1});function ce(t,e){for(let r=0,s=e.length;r<s;r++){let i=e[r];t.has(i)||(t.add(i),i.extends&&ce(t,i.extends))}}function de(t){if(t){let e=new Set;return ce(e,t),[...e]}}var rt={0:"Symbol.asyncIterator",1:"Symbol.hasInstance",2:"Symbol.isConcatSpreadable",3:"Symbol.iterator",4:"Symbol.match",5:"Symbol.matchAll",6:"Symbol.replace",7:"Symbol.search",8:"Symbol.species",9:"Symbol.split",10:"Symbol.toPrimitive",11:"Symbol.toStringTag",12:"Symbol.unscopables"},he={[Symbol.asyncIterator]:0,[Symbol.hasInstance]:1,[Symbol.isConcatSpreadable]:2,[Symbol.iterator]:3,[Symbol.match]:4,[Symbol.matchAll]:5,[Symbol.replace]:6,[Symbol.search]:7,[Symbol.species]:8,[Symbol.split]:9,[Symbol.toPrimitive]:10,[Symbol.toStringTag]:11,[Symbol.unscopables]:12},st={0:Symbol.asyncIterator,1:Symbol.hasInstance,2:Symbol.isConcatSpreadable,3:Symbol.iterator,4:Symbol.match,5:Symbol.matchAll,6:Symbol.replace,7:Symbol.search,8:Symbol.species,9:Symbol.split,10:Symbol.toPrimitive,11:Symbol.toStringTag,12:Symbol.unscopables},it={2:"!0",3:"!1",1:"void 0",0:"null",4:"-0",5:"1/0",6:"-1/0",7:"0/0"},at={2:!0,3:!1,1:void 0,0:null,4:-0,5:1/0,6:-1/0,7:NaN},fe={0:"Error",1:"EvalError",2:"RangeError",3:"ReferenceError",4:"SyntaxError",5:"TypeError",6:"URIError"},nt={0:Error,1:EvalError,2:RangeError,3:ReferenceError,4:SyntaxError,5:TypeError,6:URIError};function p(t){return{t:2,i:void 0,s:t,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}var U=p(2),M=p(3),ot=p(1),lt=p(0),ut=p(4),ct=p(5),dt=p(6),ht=p(7);function L(t){return t instanceof EvalError?1:t instanceof RangeError?2:t instanceof ReferenceError?3:t instanceof SyntaxError?4:t instanceof TypeError?5:t instanceof URIError?6:0}function ft(t){let e=fe[L(t)];return t.name!==e?{name:t.name}:t.constructor.name!==e?{name:t.constructor.name}:{}}function Z(t,e){let r=ft(t),s=Object.getOwnPropertyNames(t);for(let i=0,a=s.length,n;i<a;i++)n=s[i],n!=="name"&&n!=="message"&&(n==="stack"?e&4&&(r=r||{},r[n]=t[n]):(r=r||{},r[n]=t[n]));return r}function pe(t){return Object.isFrozen(t)?3:Object.isSealed(t)?2:Object.isExtensible(t)?0:1}function pt(t){switch(t){case 1/0:return ct;case-1/0:return dt}return t!==t?ht:Object.is(t,-0)?ut:{t:0,i:void 0,s:t,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function q(t){return{t:1,i:void 0,s:h(t),l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function vt(t){return{t:3,i:void 0,s:""+t,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function gt(t){return{t:4,i:t,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function yt(t,e){return{t:5,i:t,s:e.toISOString(),l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,f:void 0,a:void 0,b:void 0,o:void 0}}function mt(t,e){return{t:6,i:t,s:void 0,l:void 0,c:h(e.source),m:e.flags,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function bt(t,e){let r=new Uint8Array(e),s=r.length,i=new Array(s);for(let a=0;a<s;a++)i[a]=r[a];return{t:19,i:t,s:i,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function zt(t,e){return{t:17,i:t,s:he[e],l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function G(t,e){return{t:18,i:t,s:h(et(e)),l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function ve(t,e,r){return{t:25,i:t,s:r,l:void 0,c:h(e),m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function wt(t,e,r){return{t:9,i:t,s:void 0,l:e.length,c:void 0,m:void 0,p:void 0,e:void 0,a:r,f:void 0,b:void 0,o:pe(e)}}function St(t,e){return{t:21,i:t,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:e,b:void 0,o:void 0}}function Rt(t,e,r){return{t:15,i:t,s:void 0,l:e.length,c:e.constructor.name,m:void 0,p:void 0,e:void 0,a:void 0,f:r,b:e.byteOffset,o:void 0}}function xt(t,e,r){return{t:16,i:t,s:void 0,l:e.length,c:e.constructor.name,m:void 0,p:void 0,e:void 0,a:void 0,f:r,b:e.byteOffset,o:void 0}}function At(t,e,r){return{t:20,i:t,s:void 0,l:e.byteLength,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:r,b:e.byteOffset,o:void 0}}function It(t,e,r){return{t:13,i:t,s:L(e),l:void 0,c:void 0,m:h(e.message),p:r,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function Et(t,e,r){return{t:14,i:t,s:L(e),l:void 0,c:void 0,m:h(e.message),p:r,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}function Pt(t,e,r){return{t:7,i:t,s:void 0,l:e,c:void 0,m:void 0,p:void 0,e:void 0,a:r,f:void 0,b:void 0,o:void 0}}function ge(t,e){return{t:28,i:void 0,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:[t,e],f:void 0,b:void 0,o:void 0}}function ye(t,e){return{t:30,i:void 0,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:[t,e],f:void 0,b:void 0,o:void 0}}function me(t,e,r){return{t:31,i:t,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:r,f:e,b:void 0,o:void 0}}function kt(t,e){return{t:32,i:t,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:e,b:void 0,o:void 0}}function Ft(t,e){return{t:33,i:t,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:e,b:void 0,o:void 0}}function Ot(t,e){return{t:34,i:t,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:e,b:void 0,o:void 0}}function be(t){let e=[],r=-1,s=-1,i=t[Symbol.iterator]();for(;;)try{let a=i.next();if(e.push(a.value),a.done){s=e.length-1;break}}catch(a){r=e.length,e.push(a)}return{v:e,t:r,d:s}}function Vt(t){return()=>{let e=0;return{[Symbol.iterator](){return this},next(){if(e>t.d)return{done:!0,value:void 0};let r=e++,s=t.v[r];if(r===t.t)throw s;return{done:r===t.d,value:s}}}}}var jt={},Tt={},Ct={0:{},1:{},2:{},3:{},4:{}},{toString:B}=Object.prototype;function $t(t,e){return e instanceof Error?`Seroval caught an error during the ${t} process.
  
${e.name}
${e.message}

- For more information, please check the "cause" property of this error.
- If you believe this is an error in Seroval, please submit an issue at https://github.com/lxsmnsyc/seroval/issues/new`:`Seroval caught an error during the ${t} process.

"${B.call(e)}"

For more information, please check the "cause" property of this error.`}var W=class extends Error{constructor(e,r){super($t(e,r)),this.cause=r}},_t=class extends W{constructor(t){super("parsing",t)}},Dt=class extends W{constructor(t){super("serialization",t)}},Ut=class extends W{constructor(t){super("deserialization",t)}},I=class extends Error{constructor(e){super(`The value ${B.call(e)} of type "${typeof e}" cannot be parsed/serialized.
      
There are few workarounds for this problem:
- Transform the value in a way that it can be serialized.
- If the reference is present on multiple runtimes (isomorphic), you can use the Reference API to map the references.`),this.value=e}},ze=class extends Error{constructor(e){super('Unsupported node type "'+e.t+'".')}},we=class extends Error{constructor(e){super('Missing plugin for tag "'+e+'".')}},m=class extends Error{constructor(e){super('Missing "'+e+'" instance.')}},Mt=class extends Error{constructor(e){super('Missing reference for the value "'+B.call(e)+'" of type "'+typeof e+'"'),this.value=e}},qt=class extends Error{constructor(t){super('Missing reference for id "'+h(t)+'"')}},Ht=class extends Error{constructor(t){super('Unknown TypedArray "'+t+'"')}},Lt=class{constructor(e){this.marked=new Set,this.plugins=e.plugins,this.features=31^(e.disabledFeatures||0),this.refs=e.refs||new Map}markRef(e){this.marked.add(e)}isMarked(e){return this.marked.has(e)}getIndexedValue(e){let r=this.refs.get(e);if(r!=null)return this.markRef(r),{type:1,value:gt(r)};let s=this.refs.size;return this.refs.set(e,s),{type:0,value:s}}getReference(e){let r=this.getIndexedValue(e);return r.type===1?r:D(e)?{type:2,value:G(r.value,e)}:r}getStrictReference(e){f(D(e),new I(e));let r=this.getIndexedValue(e);return r.type===1?r.value:G(r.value,e)}parseFunction(e){return this.getStrictReference(e)}parseWellKnownSymbol(e){let r=this.getReference(e);return r.type!==0?r.value:(f(e in he,new I(e)),zt(r.value,e))}parseSpecialReference(e){let r=this.getIndexedValue(Ct[e]);return r.type===1?r.value:{t:26,i:r.value,s:e,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:void 0,b:void 0,o:void 0}}parseIteratorFactory(){let e=this.getIndexedValue(jt);return e.type===1?e.value:{t:27,i:e.value,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:this.parseWellKnownSymbol(Symbol.iterator),b:void 0,o:void 0}}parseAsyncIteratorFactory(){let e=this.getIndexedValue(Tt);return e.type===1?e.value:{t:29,i:e.value,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:[this.parseSpecialReference(1),this.parseWellKnownSymbol(Symbol.asyncIterator)],f:void 0,b:void 0,o:void 0}}createObjectNode(e,r,s,i){return{t:s?11:10,i:e,s:void 0,l:void 0,c:void 0,m:void 0,p:i,e:void 0,a:void 0,f:void 0,b:void 0,o:pe(r)}}createMapNode(e,r,s,i){return{t:8,i:e,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:{k:r,v:s,s:i},a:void 0,f:this.parseSpecialReference(0),b:void 0,o:void 0}}createPromiseConstructorNode(e){return{t:22,i:e,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:void 0,f:this.parseSpecialReference(1),b:void 0,o:void 0}}};function H(){let t,e;return{promise:new Promise((r,s)=>{t=r,e=s}),resolve(r){t(r)},reject(r){e(r)}}}function Bt(t){return"__SEROVAL_STREAM__"in t}function R(){let t=new Set,e=[],r=!0,s=!1;function i(o){for(let u of t.keys())u.next(o)}function a(o){for(let u of t.keys())u.throw(o)}function n(o){for(let u of t.keys())u.return(o)}return{__SEROVAL_STREAM__:!0,on(o){r&&t.add(o);for(let u=0,c=e.length;u<c;u++){let l=e[u];u===c-1?s?o.return(l):o.throw(l):o.next(l)}return()=>{r&&t.delete(o)}},next(o){r&&(e.push(o),i(o))},throw(o){r&&(e.push(o),a(o),r=!1,s=!1,t.clear())},return(o){r&&(e.push(o),n(o),r=!1,s=!0,t.clear())}}}function Wt(t){let e=R(),r=t[Symbol.asyncIterator]();async function s(){try{let i=await r.next();i.done?e.return(i.value):(e.next(i.value),await s())}catch(i){e.throw(i)}}return s().catch(()=>{}),e}function Nt(t){return()=>{let e=[],r=[],s=0,i=-1,a=!1;function n(){for(let u=0,c=r.length;u<c;u++)r[u].resolve({done:!0,value:void 0})}t.on({next(u){let c=r.shift();c&&c.resolve({done:!1,value:u}),e.push(u)},throw(u){let c=r.shift();c&&c.reject(u),n(),i=e.length,e.push(u),a=!0},return(u){let c=r.shift();c&&c.resolve({done:!0,value:u}),n(),i=e.length,e.push(u)}});function o(){let u=s++,c=e[u];if(u!==i)return{done:!1,value:c};if(a)throw c;return{done:!0,value:c}}return{[Symbol.asyncIterator](){return this},async next(){if(i===-1){let u=s++;if(u>=e.length){let c=H();return r.push(c),await c.promise}return{done:!1,value:e[u]}}return s>i?{done:!0,value:void 0}:o()}}}}function Kt(t){switch(t){case"Int8Array":return Int8Array;case"Int16Array":return Int16Array;case"Int32Array":return Int32Array;case"Uint8Array":return Uint8Array;case"Uint16Array":return Uint16Array;case"Uint32Array":return Uint32Array;case"Uint8ClampedArray":return Uint8ClampedArray;case"Float32Array":return Float32Array;case"Float64Array":return Float64Array;case"BigInt64Array":return BigInt64Array;case"BigUint64Array":return BigUint64Array;default:throw new Ht(t)}}function J(t,e){switch(e){case 3:return Object.freeze(t);case 1:return Object.preventExtensions(t);case 2:return Object.seal(t);default:return t}}var Zt=class{constructor(e){this.plugins=e.plugins,this.refs=e.refs||new Map}deserializeReference(e){return this.assignIndexedValue(e.i,tt(v(e.s)))}deserializeArray(e){let r=e.l,s=this.assignIndexedValue(e.i,new Array(r)),i;for(let a=0;a<r;a++)i=e.a[a],i&&(s[a]=this.deserialize(i));return J(s,e.o),s}deserializeProperties(e,r){let s=e.s;if(s){let i=e.k,a=e.v;for(let n=0,o;n<s;n++)o=i[n],typeof o=="string"?r[v(o)]=this.deserialize(a[n]):r[this.deserialize(o)]=this.deserialize(a[n])}return r}deserializeObject(e){let r=this.assignIndexedValue(e.i,e.t===10?{}:Object.create(null));return this.deserializeProperties(e.p,r),J(r,e.o),r}deserializeDate(e){return this.assignIndexedValue(e.i,new Date(e.s))}deserializeRegExp(e){return this.assignIndexedValue(e.i,new RegExp(v(e.c),e.m))}deserializeSet(e){let r=this.assignIndexedValue(e.i,new Set),s=e.a;for(let i=0,a=e.l;i<a;i++)r.add(this.deserialize(s[i]));return r}deserializeMap(e){let r=this.assignIndexedValue(e.i,new Map),s=e.e.k,i=e.e.v;for(let a=0,n=e.e.s;a<n;a++)r.set(this.deserialize(s[a]),this.deserialize(i[a]));return r}deserializeArrayBuffer(e){let r=new Uint8Array(e.s);return this.assignIndexedValue(e.i,r.buffer)}deserializeTypedArray(e){let r=Kt(e.c),s=this.deserialize(e.f);return this.assignIndexedValue(e.i,new r(s,e.b,e.l))}deserializeDataView(e){let r=this.deserialize(e.f);return this.assignIndexedValue(e.i,new DataView(r,e.b,e.l))}deserializeDictionary(e,r){if(e.p){let s=this.deserializeProperties(e.p,{});Object.assign(r,s)}return r}deserializeAggregateError(e){let r=this.assignIndexedValue(e.i,new AggregateError([],v(e.m)));return this.deserializeDictionary(e,r)}deserializeError(e){let r=nt[e.s],s=this.assignIndexedValue(e.i,new r(v(e.m)));return this.deserializeDictionary(e,s)}deserializePromise(e){let r=H(),s=this.assignIndexedValue(e.i,r),i=this.deserialize(e.f);return e.s?r.resolve(i):r.reject(i),s.promise}deserializeBoxed(e){return this.assignIndexedValue(e.i,Object(this.deserialize(e.f)))}deserializePlugin(e){let r=this.plugins;if(r){let s=v(e.c);for(let i=0,a=r.length;i<a;i++){let n=r[i];if(n.tag===s)return this.assignIndexedValue(e.i,n.deserialize(e.s,this,{id:e.i}))}}throw new we(e.c)}deserializePromiseConstructor(e){return this.assignIndexedValue(e.i,H()).promise}deserializePromiseResolve(e){let r=this.refs.get(e.i);f(r,new m("Promise")),r.resolve(this.deserialize(e.a[1]))}deserializePromiseReject(e){let r=this.refs.get(e.i);f(r,new m("Promise")),r.reject(this.deserialize(e.a[1]))}deserializeIteratorFactoryInstance(e){this.deserialize(e.a[0]);let r=this.deserialize(e.a[1]);return Vt(r)}deserializeAsyncIteratorFactoryInstance(e){this.deserialize(e.a[0]);let r=this.deserialize(e.a[1]);return Nt(r)}deserializeStreamConstructor(e){let r=this.assignIndexedValue(e.i,R()),s=e.a.length;if(s)for(let i=0;i<s;i++)this.deserialize(e.a[i]);return r}deserializeStreamNext(e){let r=this.refs.get(e.i);f(r,new m("Stream")),r.next(this.deserialize(e.f))}deserializeStreamThrow(e){let r=this.refs.get(e.i);f(r,new m("Stream")),r.throw(this.deserialize(e.f))}deserializeStreamReturn(e){let r=this.refs.get(e.i);f(r,new m("Stream")),r.return(this.deserialize(e.f))}deserializeIteratorFactory(e){this.deserialize(e.f)}deserializeAsyncIteratorFactory(e){this.deserialize(e.a[1])}deserialize(e){try{switch(e.t){case 2:return at[e.s];case 0:return e.s;case 1:return v(e.s);case 3:return BigInt(e.s);case 4:return this.refs.get(e.i);case 18:return this.deserializeReference(e);case 9:return this.deserializeArray(e);case 10:case 11:return this.deserializeObject(e);case 5:return this.deserializeDate(e);case 6:return this.deserializeRegExp(e);case 7:return this.deserializeSet(e);case 8:return this.deserializeMap(e);case 19:return this.deserializeArrayBuffer(e);case 16:case 15:return this.deserializeTypedArray(e);case 20:return this.deserializeDataView(e);case 14:return this.deserializeAggregateError(e);case 13:return this.deserializeError(e);case 12:return this.deserializePromise(e);case 17:return st[e.s];case 21:return this.deserializeBoxed(e);case 25:return this.deserializePlugin(e);case 22:return this.deserializePromiseConstructor(e);case 23:return this.deserializePromiseResolve(e);case 24:return this.deserializePromiseReject(e);case 28:return this.deserializeIteratorFactoryInstance(e);case 30:return this.deserializeAsyncIteratorFactoryInstance(e);case 31:return this.deserializeStreamConstructor(e);case 32:return this.deserializeStreamNext(e);case 33:return this.deserializeStreamThrow(e);case 34:return this.deserializeStreamReturn(e);case 27:return this.deserializeIteratorFactory(e);case 29:return this.deserializeAsyncIteratorFactory(e);default:throw new ze(e)}}catch(r){throw new Ut(r)}}},Gt=class extends Zt{constructor(e){super(e),this.mode="vanilla",this.marked=new Set(e.markedRefs)}assignIndexedValue(e,r){return this.marked.has(e)&&this.refs.set(e,r),r}},Jt=/^[$A-Z_][0-9A-Z_$]*$/i;function Q(t){let e=t[0];return(e==="$"||e==="_"||e>="A"&&e<="Z"||e>="a"&&e<="z")&&Jt.test(t)}function z(t){switch(t.t){case 0:return t.s+"="+t.v;case 2:return t.s+".set("+t.k+","+t.v+")";case 1:return t.s+".add("+t.v+")";case 3:return t.s+".delete("+t.k+")"}}function Qt(t){let e=[],r=t[0];for(let s=1,i=t.length,a,n=r;s<i;s++)a=t[s],a.t===0&&a.v===n.v?r={t:0,s:a.s,k:void 0,v:z(r)}:a.t===2&&a.s===n.s?r={t:2,s:z(r),k:a.k,v:a.v}:a.t===1&&a.s===n.s?r={t:1,s:z(r),k:void 0,v:a.v}:a.t===3&&a.s===n.s?r={t:3,s:z(r),k:a.k,v:void 0}:(e.push(r),r=a),n=a;return e.push(r),e}function Y(t){if(t.length){let e="",r=Qt(t);for(let s=0,i=r.length;s<i;s++)e+=z(r[s])+",";return e}}var Yt="Object.create(null)",Xt="new Set",er="new Map",tr="Promise.resolve",rr="Promise.reject",sr={3:"Object.freeze",2:"Object.seal",1:"Object.preventExtensions",0:void 0},ir=class{constructor(t){this.stack=[],this.flags=[],this.assignments=[],this.plugins=t.plugins,this.features=t.features,this.marked=new Set(t.markedRefs)}createFunction(t,e){return this.features&2?(t.length===1?t[0]:"("+t.join(",")+")")+"=>"+e:"function("+t.join(",")+"){return "+e+"}"}createEffectfulFunction(t,e){return this.features&2?(t.length===1?t[0]:"("+t.join(",")+")")+"=>{"+e+"}":"function("+t.join(",")+"){"+e+"}"}markRef(t){this.marked.add(t)}isMarked(t){return this.marked.has(t)}pushObjectFlag(t,e){t!==0&&(this.markRef(e),this.flags.push({type:t,value:this.getRefParam(e)}))}resolveFlags(){let t="";for(let e=0,r=this.flags,s=r.length;e<s;e++){let i=r[e];t+=sr[i.type]+"("+i.value+"),"}return t}resolvePatches(){let t=Y(this.assignments),e=this.resolveFlags();return t?e?t+e:t:e}createAssignment(t,e){this.assignments.push({t:0,s:t,k:void 0,v:e})}createAddAssignment(t,e){this.assignments.push({t:1,s:this.getRefParam(t),k:void 0,v:e})}createSetAssignment(t,e,r){this.assignments.push({t:2,s:this.getRefParam(t),k:e,v:r})}createDeleteAssignment(t,e){this.assignments.push({t:3,s:this.getRefParam(t),k:e,v:void 0})}createArrayAssign(t,e,r){this.createAssignment(this.getRefParam(t)+"["+e+"]",r)}createObjectAssign(t,e,r){this.createAssignment(this.getRefParam(t)+"."+e,r)}isIndexedValueInStack(t){return t.t===4&&this.stack.includes(t.i)}serializeReference(t){return this.assignIndexedValue(t.i,b+'.get("'+t.s+'")')}serializeArrayItem(t,e,r){return e?this.isIndexedValueInStack(e)?(this.markRef(t),this.createArrayAssign(t,r,this.getRefParam(e.i)),""):this.serialize(e):""}serializeArray(t){let e=t.i;if(t.l){this.stack.push(e);let r=t.a,s=this.serializeArrayItem(e,r[0],0),i=s==="";for(let a=1,n=t.l,o;a<n;a++)o=this.serializeArrayItem(e,r[a],a),s+=","+o,i=o==="";return this.stack.pop(),this.pushObjectFlag(t.o,t.i),this.assignIndexedValue(e,"["+s+(i?",]":"]"))}return this.assignIndexedValue(e,"[]")}serializeProperty(t,e,r){if(typeof e=="string"){let s=Number(e),i=s>=0&&s.toString()===e||Q(e);if(this.isIndexedValueInStack(r)){let a=this.getRefParam(r.i);return this.markRef(t.i),i&&s!==s?this.createObjectAssign(t.i,e,a):this.createArrayAssign(t.i,i?e:'"'+e+'"',a),""}return(i?e:'"'+e+'"')+":"+this.serialize(r)}return"["+this.serialize(e)+"]:"+this.serialize(r)}serializeProperties(t,e){let r=e.s;if(r){let s=e.k,i=e.v;this.stack.push(t.i);let a=this.serializeProperty(t,s[0],i[0]);for(let n=1,o=a;n<r;n++)o=this.serializeProperty(t,s[n],i[n]),a+=(o&&a&&",")+o;return this.stack.pop(),"{"+a+"}"}return"{}"}serializeObject(t){return this.pushObjectFlag(t.o,t.i),this.assignIndexedValue(t.i,this.serializeProperties(t,t.p))}serializeWithObjectAssign(t,e,r){let s=this.serializeProperties(t,e);return s!=="{}"?"Object.assign("+r+","+s+")":r}serializeStringKeyAssignment(t,e,r,s){let i=this.serialize(s),a=Number(r),n=a>=0&&a.toString()===r||Q(r);if(this.isIndexedValueInStack(s))n&&a!==a?this.createObjectAssign(t.i,r,i):this.createArrayAssign(t.i,n?r:'"'+r+'"',i);else{let o=this.assignments;this.assignments=e,n&&a!==a?this.createObjectAssign(t.i,r,i):this.createArrayAssign(t.i,n?r:'"'+r+'"',i),this.assignments=o}}serializeAssignment(t,e,r,s){if(typeof r=="string")this.serializeStringKeyAssignment(t,e,r,s);else{let i=this.stack;this.stack=[];let a=this.serialize(s);this.stack=i;let n=this.assignments;this.assignments=e,this.createArrayAssign(t.i,this.serialize(r),a),this.assignments=n}}serializeAssignments(t,e){let r=e.s;if(r){let s=[],i=e.k,a=e.v;this.stack.push(t.i);for(let n=0;n<r;n++)this.serializeAssignment(t,s,i[n],a[n]);return this.stack.pop(),Y(s)}}serializeDictionary(t,e){if(t.p)if(this.features&8)e=this.serializeWithObjectAssign(t,t.p,e);else{this.markRef(t.i);let r=this.serializeAssignments(t,t.p);if(r)return"("+this.assignIndexedValue(t.i,e)+","+r+this.getRefParam(t.i)+")"}return this.assignIndexedValue(t.i,e)}serializeNullConstructor(t){return this.pushObjectFlag(t.o,t.i),this.serializeDictionary(t,Yt)}serializeDate(t){return this.assignIndexedValue(t.i,'new Date("'+t.s+'")')}serializeRegExp(t){return this.assignIndexedValue(t.i,"/"+t.c+"/"+t.m)}serializeSetItem(t,e){return this.isIndexedValueInStack(e)?(this.markRef(t),this.createAddAssignment(t,this.getRefParam(e.i)),""):this.serialize(e)}serializeSet(t){let e=Xt,r=t.l,s=t.i;if(r){let i=t.a;this.stack.push(s);let a=this.serializeSetItem(s,i[0]);for(let n=1,o=a;n<r;n++)o=this.serializeSetItem(s,i[n]),a+=(o&&a&&",")+o;this.stack.pop(),a&&(e+="(["+a+"])")}return this.assignIndexedValue(s,e)}serializeMapEntry(t,e,r,s){if(this.isIndexedValueInStack(e)){let i=this.getRefParam(e.i);if(this.markRef(t),this.isIndexedValueInStack(r)){let n=this.getRefParam(r.i);return this.createSetAssignment(t,i,n),""}if(r.t!==4&&r.i!=null&&this.isMarked(r.i)){let n="("+this.serialize(r)+",["+s+","+s+"])";return this.createSetAssignment(t,i,this.getRefParam(r.i)),this.createDeleteAssignment(t,s),n}let a=this.stack;return this.stack=[],this.createSetAssignment(t,i,this.serialize(r)),this.stack=a,""}if(this.isIndexedValueInStack(r)){let i=this.getRefParam(r.i);if(this.markRef(t),e.t!==4&&e.i!=null&&this.isMarked(e.i)){let n="("+this.serialize(e)+",["+s+","+s+"])";return this.createSetAssignment(t,this.getRefParam(e.i),i),this.createDeleteAssignment(t,s),n}let a=this.stack;return this.stack=[],this.createSetAssignment(t,this.serialize(e),i),this.stack=a,""}return"["+this.serialize(e)+","+this.serialize(r)+"]"}serializeMap(t){let e=er,r=t.e.s,s=t.i,i=t.f,a=this.getRefParam(i.i);if(r){let n=t.e.k,o=t.e.v;this.stack.push(s);let u=this.serializeMapEntry(s,n[0],o[0],a);for(let c=1,l=u;c<r;c++)l=this.serializeMapEntry(s,n[c],o[c],a),u+=(l&&u&&",")+l;this.stack.pop(),u&&(e+="(["+u+"])")}return i.t===26&&(this.markRef(i.i),e="("+this.serialize(i)+","+e+")"),this.assignIndexedValue(s,e)}serializeArrayBuffer(t){let e="new Uint8Array(",r=t.s,s=r.length;if(s){e+="["+r[0];for(let i=1;i<s;i++)e+=","+r[i];e+="]"}return this.assignIndexedValue(t.i,e+").buffer")}serializeTypedArray(t){return this.assignIndexedValue(t.i,"new "+t.c+"("+this.serialize(t.f)+","+t.b+","+t.l+")")}serializeDataView(t){return this.assignIndexedValue(t.i,"new DataView("+this.serialize(t.f)+","+t.b+","+t.l+")")}serializeAggregateError(t){let e=t.i;this.stack.push(e);let r=this.serializeDictionary(t,'new AggregateError([],"'+t.m+'")');return this.stack.pop(),r}serializeError(t){return this.serializeDictionary(t,"new "+fe[t.s]+'("'+t.m+'")')}serializePromise(t){let e,r=t.f,s=t.i,i=t.s?tr:rr;if(this.isIndexedValueInStack(r)){let a=this.getRefParam(r.i);e=i+(t.s?"().then("+this.createFunction([],a)+")":"().catch("+this.createEffectfulFunction([],"throw "+a)+")")}else{this.stack.push(s);let a=this.serialize(r);this.stack.pop(),e=i+"("+a+")"}return this.assignIndexedValue(s,e)}serializeWellKnownSymbol(t){return this.assignIndexedValue(t.i,rt[t.s])}serializeBoxed(t){return this.assignIndexedValue(t.i,"Object("+this.serialize(t.f)+")")}serializePlugin(t){let e=this.plugins;if(e)for(let r=0,s=e.length;r<s;r++){let i=e[r];if(i.tag===t.c)return this.assignIndexedValue(t.i,i.serialize(t.s,this,{id:t.i}))}throw new we(t.c)}getConstructor(t){let e=this.serialize(t);return e===this.getRefParam(t.i)?e:"("+e+")"}serializePromiseConstructor(t){return this.assignIndexedValue(t.i,this.getConstructor(t.f)+"()")}serializePromiseResolve(t){return this.getConstructor(t.a[0])+"("+this.getRefParam(t.i)+","+this.serialize(t.a[1])+")"}serializePromiseReject(t){return this.getConstructor(t.a[0])+"("+this.getRefParam(t.i)+","+this.serialize(t.a[1])+")"}serializeSpecialReferenceValue(t){switch(t){case 0:return"[]";case 1:return this.createFunction(["s","f","p"],"((p=new Promise("+this.createEffectfulFunction(["a","b"],"s=a,f=b")+")).s=s,p.f=f,p)");case 2:return this.createEffectfulFunction(["p","d"],'p.s(d),p.status="success",p.value=d;delete p.s;delete p.f');case 3:return this.createEffectfulFunction(["p","d"],'p.f(d),p.status="failure",p.value=d;delete p.s;delete p.f');case 4:return this.createFunction(["b","a","s","l","p","f","e","n"],"(b=[],a=!0,s=!1,l=[],p=0,f="+this.createEffectfulFunction(["v","m","x"],"for(x=0;x<p;x++)l[x]&&l[x][m](v)")+",n="+this.createEffectfulFunction(["o","x","z","c"],'for(x=0,z=b.length;x<z;x++)(c=b[x],x===z-1?o[s?"return":"throw"](c):o.next(c))')+",e="+this.createFunction(["o","t"],"(a&&(l[t=p++]=o),n(o),"+this.createEffectfulFunction([],"a&&(l[t]=void 0)")+")")+",{__SEROVAL_STREAM__:!0,on:"+this.createFunction(["o"],"e(o)")+",next:"+this.createEffectfulFunction(["v"],'a&&(b.push(v),f(v,"next"))')+",throw:"+this.createEffectfulFunction(["v"],'a&&(b.push(v),f(v,"throw"),a=s=!1,l.length=0)')+",return:"+this.createEffectfulFunction(["v"],'a&&(b.push(v),f(v,"return"),a=!1,s=!0,l.length=0)')+"})");default:return""}}serializeSpecialReference(t){return this.assignIndexedValue(t.i,this.serializeSpecialReferenceValue(t.s))}serializeIteratorFactory(t){let e="",r=!1;return t.f.t!==4&&(this.markRef(t.f.i),e="("+this.serialize(t.f)+",",r=!0),e+=this.assignIndexedValue(t.i,this.createFunction(["s"],this.createFunction(["i","c","d","t"],"(i=0,t={["+this.getRefParam(t.f.i)+"]:"+this.createFunction([],"t")+",next:"+this.createEffectfulFunction([],"if(i>s.d)return{done:!0,value:void 0};if(d=s.v[c=i++],c===s.t)throw d;return{done:c===s.d,value:d}")+"})"))),r&&(e+=")"),e}serializeIteratorFactoryInstance(t){return this.getConstructor(t.a[0])+"("+this.serialize(t.a[1])+")"}serializeAsyncIteratorFactory(t){let e=t.a[0],r=t.a[1],s="";e.t!==4&&(this.markRef(e.i),s+="("+this.serialize(e)),r.t!==4&&(this.markRef(r.i),s+=(s?",":"(")+this.serialize(r)),s&&(s+=",");let i=this.assignIndexedValue(t.i,this.createFunction(["s"],this.createFunction(["b","c","p","d","e","t","f"],"(b=[],c=0,p=[],d=-1,e=!1,f="+this.createEffectfulFunction(["i","l"],"for(i=0,l=p.length;i<l;i++)p[i].s({done:!0,value:void 0})")+",s.on({next:"+this.createEffectfulFunction(["v","t"],"if(t=p.shift())t.s({done:!1,value:v});b.push(v)")+",throw:"+this.createEffectfulFunction(["v","t"],"if(t=p.shift())t.f(v);f(),d=b.length,e=!0,b.push(v)")+",return:"+this.createEffectfulFunction(["v","t"],"if(t=p.shift())t.s({done:!0,value:v});f(),d=b.length,b.push(v)")+"}),t={["+this.getRefParam(r.i)+"]:"+this.createFunction([],"t")+",next:"+this.createEffectfulFunction(["i","t","v"],"if(d===-1){return((i=c++)>=b.length)?(p.push(t="+this.getRefParam(e.i)+"()),t):{done:!0,value:b[i]}}if(c>d)return{done:!0,value:void 0};if(v=b[i=c++],i!==d)return{done:!1,value:v};if(e)throw v;return{done:!0,value:v}")+"})")));return s?s+i+")":i}serializeAsyncIteratorFactoryInstance(t){return this.getConstructor(t.a[0])+"("+this.serialize(t.a[1])+")"}serializeStreamConstructor(t){let e=this.assignIndexedValue(t.i,this.getConstructor(t.f)+"()"),r=t.a.length;if(r){let s=this.serialize(t.a[0]);for(let i=1;i<r;i++)s+=","+this.serialize(t.a[i]);return"("+e+","+s+","+this.getRefParam(t.i)+")"}return e}serializeStreamNext(t){return this.getRefParam(t.i)+".next("+this.serialize(t.f)+")"}serializeStreamThrow(t){return this.getRefParam(t.i)+".throw("+this.serialize(t.f)+")"}serializeStreamReturn(t){return this.getRefParam(t.i)+".return("+this.serialize(t.f)+")"}serialize(t){try{switch(t.t){case 2:return it[t.s];case 0:return""+t.s;case 1:return'"'+t.s+'"';case 3:return t.s+"n";case 4:return this.getRefParam(t.i);case 18:return this.serializeReference(t);case 9:return this.serializeArray(t);case 10:return this.serializeObject(t);case 11:return this.serializeNullConstructor(t);case 5:return this.serializeDate(t);case 6:return this.serializeRegExp(t);case 7:return this.serializeSet(t);case 8:return this.serializeMap(t);case 19:return this.serializeArrayBuffer(t);case 16:case 15:return this.serializeTypedArray(t);case 20:return this.serializeDataView(t);case 14:return this.serializeAggregateError(t);case 13:return this.serializeError(t);case 12:return this.serializePromise(t);case 17:return this.serializeWellKnownSymbol(t);case 21:return this.serializeBoxed(t);case 22:return this.serializePromiseConstructor(t);case 23:return this.serializePromiseResolve(t);case 24:return this.serializePromiseReject(t);case 25:return this.serializePlugin(t);case 26:return this.serializeSpecialReference(t);case 27:return this.serializeIteratorFactory(t);case 28:return this.serializeIteratorFactoryInstance(t);case 29:return this.serializeAsyncIteratorFactory(t);case 30:return this.serializeAsyncIteratorFactoryInstance(t);case 31:return this.serializeStreamConstructor(t);case 32:return this.serializeStreamNext(t);case 33:return this.serializeStreamThrow(t);case 34:return this.serializeStreamReturn(t);default:throw new ze(t)}}catch(e){throw new Dt(e)}}},ar=class extends Lt{parseItems(e){let r=[];for(let s=0,i=e.length;s<i;s++)s in e&&(r[s]=this.parse(e[s]));return r}parseArray(e,r){return wt(e,r,this.parseItems(r))}parseProperties(e){let r=Object.entries(e),s=[],i=[];for(let n=0,o=r.length;n<o;n++)s.push(h(r[n][0])),i.push(this.parse(r[n][1]));let a=Symbol.iterator;return a in e&&(s.push(this.parseWellKnownSymbol(a)),i.push(ge(this.parseIteratorFactory(),this.parse(be(e))))),a=Symbol.asyncIterator,a in e&&(s.push(this.parseWellKnownSymbol(a)),i.push(ye(this.parseAsyncIteratorFactory(),this.parse(R())))),a=Symbol.toStringTag,a in e&&(s.push(this.parseWellKnownSymbol(a)),i.push(q(e[a]))),a=Symbol.isConcatSpreadable,a in e&&(s.push(this.parseWellKnownSymbol(a)),i.push(e[a]?U:M)),{k:s,v:i,s:s.length}}parsePlainObject(e,r,s){return this.createObjectNode(e,r,s,this.parseProperties(r))}parseBoxed(e,r){return St(e,this.parse(r.valueOf()))}parseTypedArray(e,r){return Rt(e,r,this.parse(r.buffer))}parseBigIntTypedArray(e,r){return xt(e,r,this.parse(r.buffer))}parseDataView(e,r){return At(e,r,this.parse(r.buffer))}parseError(e,r){let s=Z(r,this.features);return It(e,r,s?this.parseProperties(s):void 0)}parseAggregateError(e,r){let s=Z(r,this.features);return Et(e,r,s?this.parseProperties(s):void 0)}parseMap(e,r){let s=[],i=[];for(let[a,n]of r.entries())s.push(this.parse(a)),i.push(this.parse(n));return this.createMapNode(e,s,i,r.size)}parseSet(e,r){let s=[];for(let i of r.keys())s.push(this.parse(i));return Pt(e,r.size,s)}parsePlugin(e,r){let s=this.plugins;if(s)for(let i=0,a=s.length;i<a;i++){let n=s[i];if(n.parse.sync&&n.test(r))return ve(e,n.tag,n.parse.sync(r,this,{id:e}))}}parseStream(e,r){return me(e,this.parseSpecialReference(4),[])}parsePromise(e,r){return this.createPromiseConstructorNode(e)}parseObject(e,r){if(Array.isArray(r))return this.parseArray(e,r);if(Bt(r))return this.parseStream(e,r);let s=this.parsePlugin(e,r);if(s)return s;let i=r.constructor;switch(i){case Object:return this.parsePlainObject(e,r,!1);case void 0:return this.parsePlainObject(e,r,!0);case Date:return yt(e,r);case RegExp:return mt(e,r);case Error:case EvalError:case RangeError:case ReferenceError:case SyntaxError:case TypeError:case URIError:return this.parseError(e,r);case Number:case Boolean:case String:case BigInt:return this.parseBoxed(e,r);case ArrayBuffer:return bt(e,r);case Int8Array:case Int16Array:case Int32Array:case Uint8Array:case Uint16Array:case Uint32Array:case Uint8ClampedArray:case Float32Array:case Float64Array:return this.parseTypedArray(e,r);case DataView:return this.parseDataView(e,r);case Map:return this.parseMap(e,r);case Set:return this.parseSet(e,r)}if(i===Promise||r instanceof Promise)return this.parsePromise(e,r);let a=this.features;if(a&16)switch(i){case BigInt64Array:case BigUint64Array:return this.parseBigIntTypedArray(e,r)}if(a&1&&typeof AggregateError<"u"&&(i===AggregateError||r instanceof AggregateError))return this.parseAggregateError(e,r);if(r instanceof Error)return this.parseError(e,r);if(Symbol.iterator in r||Symbol.asyncIterator in r)return this.parsePlainObject(e,r,!!i);throw new I(r)}parse(e){try{switch(typeof e){case"boolean":return e?U:M;case"undefined":return ot;case"string":return q(e);case"number":return pt(e);case"bigint":return vt(e);case"object":{if(e){let r=this.getReference(e);return r.type===0?this.parseObject(r.value,e):r.value}return lt}case"symbol":return this.parseWellKnownSymbol(e);case"function":return this.parseFunction(e);default:throw new I(e)}}catch(r){throw new _t(r)}}};function nr(t,e={}){let r=de(e.plugins);return new Gt({plugins:r,markedRefs:t.m}).deserialize(t.t)}var or=class extends ir{constructor(e){super(e),this.mode="cross",this.scopeId=e.scopeId}getRefParam(e){return A+"["+e+"]"}assignIndexedValue(e,r){return this.getRefParam(e)+"="+r}serializeTop(e){let r=this.serialize(e),s=e.i;if(s==null)return r;let i=this.resolvePatches(),a=this.getRefParam(s),n=this.scopeId==null?"":A,o=i?r+","+i+a:r;if(n==="")return i?"("+o+")":o;let u=this.scopeId==null?"()":"("+A+'["'+h(this.scopeId)+'"])';return"("+this.createFunction([n],o)+")"+u}},lr=class extends ar{constructor(e){super(e),this.alive=!0,this.pending=0,this.initial=!0,this.buffer=[],this.onParseCallback=e.onParse,this.onErrorCallback=e.onError,this.onDoneCallback=e.onDone}onParseInternal(e,r){try{this.onParseCallback(e,r)}catch(s){this.onError(s)}}flush(){for(let e=0,r=this.buffer.length;e<r;e++)this.onParseInternal(this.buffer[e],!1)}onParse(e){this.initial?this.buffer.push(e):this.onParseInternal(e,!1)}onError(e){if(this.onErrorCallback)this.onErrorCallback(e);else throw e}onDone(){this.onDoneCallback&&this.onDoneCallback()}pushPendingState(){this.pending++}popPendingState(){--this.pending<=0&&this.onDone()}parseProperties(e){let r=Object.entries(e),s=[],i=[];for(let n=0,o=r.length;n<o;n++)s.push(h(r[n][0])),i.push(this.parse(r[n][1]));let a=Symbol.iterator;return a in e&&(s.push(this.parseWellKnownSymbol(a)),i.push(ge(this.parseIteratorFactory(),this.parse(be(e))))),a=Symbol.asyncIterator,a in e&&(s.push(this.parseWellKnownSymbol(a)),i.push(ye(this.parseAsyncIteratorFactory(),this.parse(Wt(e))))),a=Symbol.toStringTag,a in e&&(s.push(this.parseWellKnownSymbol(a)),i.push(q(e[a]))),a=Symbol.isConcatSpreadable,a in e&&(s.push(this.parseWellKnownSymbol(a)),i.push(e[a]?U:M)),{k:s,v:i,s:s.length}}parsePromise(e,r){return r.then(s=>{let i=this.parseWithError(s);i&&this.onParse({t:23,i:e,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:[this.parseSpecialReference(2),i],f:void 0,b:void 0,o:void 0}),this.popPendingState()},s=>{if(this.alive){let i=this.parseWithError(s);i&&this.onParse({t:24,i:e,s:void 0,l:void 0,c:void 0,m:void 0,p:void 0,e:void 0,a:[this.parseSpecialReference(3),i],f:void 0,b:void 0,o:void 0})}this.popPendingState()}),this.pushPendingState(),this.createPromiseConstructorNode(e)}parsePlugin(e,r){let s=this.plugins;if(s)for(let i=0,a=s.length;i<a;i++){let n=s[i];if(n.parse.stream&&n.test(r))return ve(e,n.tag,n.parse.stream(r,this,{id:e}))}}parseStream(e,r){let s=me(e,this.parseSpecialReference(4),[]);return this.pushPendingState(),r.on({next:i=>{if(this.alive){let a=this.parseWithError(i);a&&this.onParse(kt(e,a))}},throw:i=>{if(this.alive){let a=this.parseWithError(i);a&&this.onParse(Ft(e,a))}this.popPendingState()},return:i=>{if(this.alive){let a=this.parseWithError(i);a&&this.onParse(Ot(e,a))}this.popPendingState()}}),s}parseWithError(e){try{return this.parse(e)}catch(r){this.onError(r);return}}start(e){let r=this.parseWithError(e);r&&(this.onParseInternal(r,!0),this.initial=!1,this.flush(),this.pending<=0&&this.destroy())}destroy(){this.alive&&(this.onDone(),this.alive=!1)}isAlive(){return this.alive}},ur=class extends lr{constructor(){super(...arguments),this.mode="cross"}};function cr(t,e){let r=de(e.plugins),s=new ur({plugins:r,refs:e.refs,disabledFeatures:e.disabledFeatures,onParse(i,a){let n=new or({plugins:r,features:s.features,scopeId:e.scopeId,markedRefs:s.marked}),o;try{o=n.serializeTop(i)}catch(u){e.onError&&e.onError(u);return}e.onSerialize(o,a)},onError:e.onError,onDone:e.onDone});return s.start(t),()=>{s.destroy()}}function F(t){return{detail:t.detail,bubbles:t.bubbles,cancelable:t.cancelable,composed:t.composed}}var dr={tag:"seroval-plugins/web/CustomEvent",test(t){return typeof CustomEvent>"u"?!1:t instanceof CustomEvent},parse:{sync(t,e){return{type:e.parse(t.type),options:e.parse(F(t))}},async async(t,e){return{type:await e.parse(t.type),options:await e.parse(F(t))}},stream(t,e){return{type:e.parse(t.type),options:e.parse(F(t))}}},serialize(t,e){return"new CustomEvent("+e.serialize(t.type)+","+e.serialize(t.options)+")"},deserialize(t,e){return new CustomEvent(e.deserialize(t.type),e.deserialize(t.options))}},Se=dr,hr={tag:"seroval-plugins/web/DOMException",test(t){return typeof DOMException>"u"?!1:t instanceof DOMException},parse:{sync(t,e){return{name:e.parse(t.name),message:e.parse(t.message)}},async async(t,e){return{name:await e.parse(t.name),message:await e.parse(t.message)}},stream(t,e){return{name:e.parse(t.name),message:e.parse(t.message)}}},serialize(t,e){return"new DOMException("+e.serialize(t.message)+","+e.serialize(t.name)+")"},deserialize(t,e){return new DOMException(e.deserialize(t.message),e.deserialize(t.name))}},Re=hr;function O(t){return{bubbles:t.bubbles,cancelable:t.cancelable,composed:t.composed}}var fr={tag:"seroval-plugins/web/Event",test(t){return typeof Event>"u"?!1:t instanceof Event},parse:{sync(t,e){return{type:e.parse(t.type),options:e.parse(O(t))}},async async(t,e){return{type:await e.parse(t.type),options:await e.parse(O(t))}},stream(t,e){return{type:e.parse(t.type),options:e.parse(O(t))}}},serialize(t,e){return"new Event("+e.serialize(t.type)+","+e.serialize(t.options)+")"},deserialize(t,e){return new Event(e.deserialize(t.type),e.deserialize(t.options))}},xe=fr,pr={tag:"seroval-plugins/web/File",test(t){return typeof File>"u"?!1:t instanceof File},parse:{async async(t,e){return{name:await e.parse(t.name),options:await e.parse({type:t.type,lastModified:t.lastModified}),buffer:await e.parse(await t.arrayBuffer())}}},serialize(t,e){return"new File(["+e.serialize(t.buffer)+"],"+e.serialize(t.name)+","+e.serialize(t.options)+")"},deserialize(t,e){return new File([e.deserialize(t.buffer)],e.deserialize(t.name),e.deserialize(t.options))}},vr=pr;function V(t){let e=[];return t.forEach((r,s)=>{e.push([s,r])}),e}var w={},gr={tag:"seroval-plugins/web/FormDataFactory",test(t){return t===w},parse:{sync(){},async async(){return await Promise.resolve(void 0)},stream(){}},serialize(t,e){return e.createEffectfulFunction(["e","f","i","s","t"],"f=new FormData;for(i=0,s=e.length;i<s;i++)f.append((t=e[i])[0],t[1]);return f")},deserialize(){return w}},yr={tag:"seroval-plugins/web/FormData",extends:[vr,gr],test(t){return typeof FormData>"u"?!1:t instanceof FormData},parse:{sync(t,e){return{factory:e.parse(w),entries:e.parse(V(t))}},async async(t,e){return{factory:await e.parse(w),entries:await e.parse(V(t))}},stream(t,e){return{factory:e.parse(w),entries:e.parse(V(t))}}},serialize(t,e){return"("+e.serialize(t.factory)+")("+e.serialize(t.entries)+")"},deserialize(t,e){let r=new FormData,s=e.deserialize(t.entries);for(let i=0,a=s.length;i<a;i++){let n=s[i];r.append(n[0],n[1])}return r}},Ae=yr;function j(t){let e=[];return t.forEach((r,s)=>{e.push([s,r])}),e}var mr={tag:"seroval-plugins/web/Headers",test(t){return typeof Headers>"u"?!1:t instanceof Headers},parse:{sync(t,e){return e.parse(j(t))},async async(t,e){return await e.parse(j(t))},stream(t,e){return e.parse(j(t))}},serialize(t,e){return"new Headers("+e.serialize(t)+")"},deserialize(t,e){return new Headers(e.deserialize(t))}},P=mr,S={},br={tag:"seroval-plugins/web/ReadableStreamFactory",test(t){return t===S},parse:{sync(){},async async(){return await Promise.resolve(void 0)},stream(){}},serialize(t,e){return e.createFunction(["d"],"new ReadableStream({start:"+e.createEffectfulFunction(["c"],"d.on({next:"+e.createEffectfulFunction(["v"],"c.enqueue(v)")+",throw:"+e.createEffectfulFunction(["v"],"c.error(v)")+",return:"+e.createEffectfulFunction([],"c.close()")+"})")+"})")},deserialize(){return S}};function X(t){let e=R(),r=t.getReader();async function s(){try{let i=await r.read();i.done?e.return(i.value):(e.next(i.value),await s())}catch(i){e.throw(i)}}return s().catch(()=>{}),e}var zr={tag:"seroval/plugins/web/ReadableStream",extends:[br],test(t){return typeof ReadableStream>"u"?!1:t instanceof ReadableStream},parse:{sync(t,e){return{factory:e.parse(S),stream:e.parse(R())}},async async(t,e){return{factory:await e.parse(S),stream:await e.parse(X(t))}},stream(t,e){return{factory:e.parse(S),stream:e.parse(X(t))}}},serialize(t,e){return"("+e.serialize(t.factory)+")("+e.serialize(t.stream)+")"},deserialize(t,e){let r=e.deserialize(t.stream);return new ReadableStream({start(s){r.on({next(i){s.enqueue(i)},throw(i){s.error(i)},return(){s.close()}})}})}},k=zr;function ee(t,e){return{body:e,cache:t.cache,credentials:t.credentials,headers:t.headers,integrity:t.integrity,keepalive:t.keepalive,method:t.method,mode:t.mode,redirect:t.redirect,referrer:t.referrer,referrerPolicy:t.referrerPolicy}}var wr={tag:"seroval-plugins/web/Request",extends:[k,P],test(t){return typeof Request>"u"?!1:t instanceof Request},parse:{async async(t,e){return{url:await e.parse(t.url),options:await e.parse(ee(t,t.body?await t.clone().arrayBuffer():null))}},stream(t,e){return{url:e.parse(t.url),options:e.parse(ee(t,t.clone().body))}}},serialize(t,e){return"new Request("+e.serialize(t.url)+","+e.serialize(t.options)+")"},deserialize(t,e){return new Request(e.deserialize(t.url),e.deserialize(t.options))}},Ie=wr;function te(t){return{headers:t.headers,status:t.status,statusText:t.statusText}}var Sr={tag:"seroval-plugins/web/Response",extends:[k,P],test(t){return typeof Response>"u"?!1:t instanceof Response},parse:{async async(t,e){return{body:await e.parse(t.body?await t.clone().arrayBuffer():null),options:await e.parse(te(t))}},stream(t,e){return{body:e.parse(t.clone().body),options:e.parse(te(t))}}},serialize(t,e){return"new Response("+e.serialize(t.body)+","+e.serialize(t.options)+")"},deserialize(t,e){return new Response(e.deserialize(t.body),e.deserialize(t.options))}},Ee=Sr,Rr={tag:"seroval-plugins/web/URLSearchParams",test(t){return typeof URLSearchParams>"u"?!1:t instanceof URLSearchParams},parse:{sync(t,e){return e.parse(t.toString())},async async(t,e){return await e.parse(t.toString())},stream(t,e){return e.parse(t.toString())}},serialize(t,e){return"new URLSearchParams("+e.serialize(t)+")"},deserialize(t,e){return new URLSearchParams(e.deserialize(t))}},Pe=Rr,xr={tag:"seroval-plugins/web/URL",test(t){return typeof URL>"u"?!1:t instanceof URL},parse:{sync(t,e){return e.parse(t.href)},async async(t,e){return await e.parse(t.href)},stream(t,e){return e.parse(t.href)}},serialize(t,e){return"new URL("+e.serialize(t)+")"},deserialize(t,e){return new URL(e.deserialize(t))}},ke=xr;function Ar(t={}){let e,r=!1;const s=n=>{if(e&&e!==n)throw new Error("Context conflict")};let i;if(t.asyncContext){const n=t.AsyncLocalStorage||globalThis.AsyncLocalStorage;n?i=new n:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const a=()=>{if(i&&e===void 0){const n=i.getStore();if(n!==void 0)return n}return e};return{use:()=>{const n=a();if(n===void 0)throw new Error("Context is not available");return n},tryUse:()=>a(),set:(n,o)=>{o||s(n),e=n,r=!0},unset:()=>{e=void 0,r=!1},call:(n,o)=>{s(n),e=n;try{return i?i.run(n,o):o()}finally{r||(e=void 0)}},async callAsync(n,o){e=n;const u=()=>{e=n},c=()=>e===n?u:void 0;ie.add(c);try{const l=i?i.run(n,o):o();return r||(e=void 0),await l}finally{ie.delete(c)}}}}function Ir(t={}){const e={};return{get(r,s={}){return e[r]||(e[r]=Ar({...t,...s})),e[r],e[r]}}}const E=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:typeof window<"u"?window:{},re="__unctx__",Er=E[re]||(E[re]=Ir()),Pr=(t,e={})=>Er.get(t,e),se="__unctx_async_handlers__",ie=E[se]||(E[se]=new Set);function kr(t){let e;const r=Fe(t),s={duplex:"half",method:t.method,headers:t.headers};return t.node.req.body instanceof ArrayBuffer?new Request(r,{...s,body:t.node.req.body}):new Request(r,{...s,get body(){return e||(e=_r(t),e)}})}function Fr(t){return t.web??={request:kr(t),url:Fe(t)},t.web.request}function Or(){return Mr()}const N=Symbol("$HTTPEvent");function Vr(t){return typeof t=="object"&&(t instanceof _||t?.[N]instanceof _||t?.__is_event__===!0)}function d(t){return function(...e){let r=e[0];if(Vr(r))e[0]=r instanceof _||r.__is_event__?r:r[N];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(r=Or(),!r)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");e.unshift(r)}return t(...e)}}const Fe=d($e),jr=d(_e),ae=d(De),ne=d(Ue),Tr=d(Me),T=d(qe),oe=d(He),Cr=d(Le),$r=d(Be),Oe=d(Ce),_r=d(We),Dr=d(Ne);function Ur(){return Pr("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:Ze})}function Mr(){return Ur().use().event}const C="Invariant Violation",{setPrototypeOf:qr=function(t,e){return t.__proto__=e,t}}=Object;class K extends Error{framesToPop=1;name=C;constructor(e=C){super(typeof e=="number"?`${C}: ${e} (see https://github.com/apollographql/invariant-packages)`:e),qr(this,K.prototype)}}function Hr(t,e){if(!t)throw new K(e)}const $=Symbol("fetchEvent");function Lr(t){return{request:Fr(t),response:Nr(t),clientAddress:jr(t),locals:{},nativeEvent:t,[N]:t}}function Br(t){if(!t[$]){const e=Lr(t);t[$]=e}return t[$]}function le(t,e){for(const[r,s]of e.entries())Oe(t,r,s)}class Wr{constructor(e){this.event=e}get(e){const r=oe(this.event,e);return Array.isArray(r)?r.join(", "):r}has(e){return this.get(e)!==void 0}set(e,r){return Cr(this.event,e,r)}delete(e){return Dr(this.event,e)}append(e,r){$r(this.event,e,r)}getSetCookie(){const e=oe(this.event,"Set-Cookie");return Array.isArray(e)?e:[e]}forEach(e){return this.entries().forEach(([r,s])=>e(s,r,this))}entries(){return T(this.event).map(([e,r])=>[e,Array.isArray(r)?r.join(", "):r])}keys(){return T(this.event).map(([e])=>e)}values(){return T(this.event).map(([e,r])=>Array.isArray(r)?r.join(", "):r)}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Nr(t){return{get status(){return ne(t)},set status(e){ae(t,e)},get statusText(){return Tr(t)},set statusText(e){ae(t,ne(),e)},headers:new Wr(t)}}function Kr(t){const r=t.length.toString(16),s="00000000".substring(0,8-r.length)+r;return new TextEncoder().encode(`;0x${s};${t}`)}function Zr(t,e){return new ReadableStream({start(r){cr(e,{scopeId:t,plugins:[Se,Re,xe,Ae,P,k,Ie,Ee,Pe,ke],onSerialize(s,i){r.enqueue(Kr(i?`(${Ye(t)},${s})`:s))},onDone(){r.close()},onError(s){r.error(s)}})}})}async function Gr(t){const e=Br(t),r=e.request,s=r.headers.get("x-server-id"),i=r.headers.get("x-server-instance"),a=new URL(r.url);let n,o;if(s)Hr(typeof s=="string","Invalid server function"),[n,o]=s.split("#");else if(n=a.searchParams.get("id"),o=a.searchParams.get("name"),!n||!o)throw new Error("Invalid request");const u=(await globalThis.MANIFEST["server-fns"].chunks[n].import())[o];let c=[];if(!i||t.method==="GET"){const l=a.searchParams.get("args");l&&JSON.parse(l).forEach(g=>c.push(g))}if(t.method==="POST"){const l=r.headers.get("content-type");if(l.startsWith("multipart/form-data")||l.startsWith("application/x-www-form-urlencoded"))c.push(await new Request(r,{...r,body:t.node.req.body}).formData());else{const g=new Request(r,{...r,body:t.node.req.body});c=nr(await g.json(),{plugins:[Se,Re,xe,Ae,P,k,Ie,Ee,Pe,ke]})}}try{let l=await Te(e,()=>(je.context={event:e},u(...c)));if(l instanceof Response){if(l.status===302)return new Response(null,{status:i?204:302,headers:{Location:l.headers.get("Location")}});l.headers&&le(t,l.headers),l.customBody?l=await l.customBody():l.body==null&&(l=void 0)}if(!i){const g=l instanceof Error,Ve=new URL(r.headers.get("referer"));return new Response(null,{status:302,headers:{Location:Ve.toString(),...l?{"Set-Cookie":`flash=${JSON.stringify({url:a.pathname+encodeURIComponent(a.search),result:g?l.message:l,error:g,input:[...c.slice(0,-1),[...c[c.length-1].entries()]]})}; Secure; HttpOnly;`}:{}}})}return typeof l=="string"?new Response(l):(Oe(t,"content-type","text/javascript"),Zr(i,l))}catch(l){if(l instanceof Response){if(l.status===302)return new Response(null,{status:i?204:302,headers:{Location:l.headers.get("Location")}});l.headers&&le(t,l.headers),l.customBody?l=await l.customBody():l.body==null&&(l=void 0)}return l}}const hs=Ke(Gr);export{hs as default};
